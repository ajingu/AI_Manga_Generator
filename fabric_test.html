<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fabric.js Speech Bubble Test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    #canvas-container { border: 1px solid #ccc; display: inline-block; }
    #controls { margin: 10px 0; }
  </style>
</head>
<body>
  <h2>Fabric.js Speech Bubble & Text Test</h2>
  <div id="controls">
    <button onclick="addSpeechBubble()">Add Speech Bubble</button>
    <input type="file" id="bgImageInput" accept="image/*" onchange="setBackgroundImage(event)">
  </div>
  <div id="canvas-container">
    <canvas id="c" width="800" height="600"></canvas>
  </div>
  <script>
    const canvas = new fabric.Canvas('c', { selection: false });

    function addSpeechBubble() {
      // Main bubble (ellipse)
      const ellipse = new fabric.Ellipse({
        left: 200,
        top: 150,
        rx: 75,
        ry: 50,
        fill: 'rgba(255,255,255,0.9)',
        stroke: 'black',
        strokeWidth: 3,
        angle: 0,
        selectable: false
      });

      // Tail (triangle)
      const tail = new fabric.Triangle({
        left: 250,
        top: 200,
        width: 30,
        height: 30,
        fill: 'rgba(255,255,255,0.9)',
        stroke: 'black',
        strokeWidth: 3,
        angle: 45,
        selectable: false
      });

      // Editable text
      const text = new fabric.IText('Double-click to edit', {
        left: 200,
        top: 150,
        fontSize: 20,
        fill: 'black',
        editable: true,
        originX: 'center',
        originY: 'center'
      });

      // Group them together
      const group = new fabric.Group([ellipse, tail, text], {
        left: 200,
        top: 150,
        angle: 0
      });

      canvas.add(group);
      canvas.setActiveObject(group);
    }

    // Double-click to edit text inside the group
    canvas.on('mouse:dblclick', function(opt) {
      const target = opt.target;
      if (target && target.type === 'group') {
        // Convert group to active selection to update child positions
        target.toActiveSelection();
        canvas.requestRenderAll();

        // Find the IText object in the selection
        const activeObjects = canvas.getActiveObjects();
        const textObj = activeObjects.find(obj => obj.type === 'i-text');
        const ellipseObj = activeObjects.find(obj => obj.type === 'ellipse');
        const tailObj = activeObjects.find(obj => obj.type === 'triangle');
        if (textObj && ellipseObj && tailObj) {
          // Remove all from canvas (they are now at correct absolute positions)
          canvas.remove(ellipseObj);
          canvas.remove(tailObj);
          canvas.remove(textObj);
          canvas.discardActiveObject();
          canvas.add(ellipseObj);
          canvas.add(tailObj);
          canvas.add(textObj);
          canvas.setActiveObject(textObj);
          textObj.enterEditing();
          textObj.selectAll();
          // When editing is exited, regroup
          textObj.on('editing:exited', function handler() {
            // Remove all from canvas
            canvas.remove(ellipseObj);
            canvas.remove(tailObj);
            canvas.remove(textObj);
            // Regroup
            const newGroup = new fabric.Group([ellipseObj, tailObj, textObj], {
              left: ellipseObj.left,
              top: ellipseObj.top,
              angle: ellipseObj.angle
            });
            canvas.add(newGroup);
            canvas.setActiveObject(newGroup);
            textObj.off('editing:exited', handler); // Remove this handler
          });
        }
      }
    });

    // Allow user to set a background image
    function setBackgroundImage(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(f) {
        fabric.Image.fromURL(f.target.result, function(img) {
          canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
            scaleX: canvas.width / img.width,
            scaleY: canvas.height / img.height
          });
        });
      };
      reader.readAsDataURL(file);
    }
  </script>
</body>
</html> 